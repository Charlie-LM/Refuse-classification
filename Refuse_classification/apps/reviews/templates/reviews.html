{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}
    评论
{% endblock %}

{% block lunbo %}
{% endblock %}
{#{% block jscss %}#}
{##}
{#    #}
{#{% endblock %}#}
{% block content %}
    <link rel="stylesheet" href="{% static 'css/style_comment.css' %}">
    <link rel="stylesheet" href="{% static 'css/comment.css' %}">
    <div class="commentAll">
        <!--评论区域 begin-->
        <div class="reviewArea clearfix">
            <textarea class="content comment-input" placeholder="Please enter a comment&hellip;"
                      onkeyup="keyUP(this)"></textarea>
            <input type="file" id="pic" name="pic" value="上传图片">
            <a href="javascript:;" class="plBtn">评论</a>
        </div>
        <!--评论区域 end-->
        <!--回复区域 begin-->
        <div class="comment-show">
            {% for say in result %}
                <div class="comment-show-con clearfix">
                    <div class="comment-show-con-img pull-left"><img src="/static/images/{{ say.user_img }}" alt="">
                    </div>
                    <div class="comment-show-con-list pull-left clearfix">
                        <div class="pl-text clearfix"><a href="#" class="comment-size-name">{{ say.username }} : </a>
                            <span class="my-pl-con">&nbsp;{{ say.content }}</span></div>
                        <div class="date-dz"><span
                                class="date-dz-left pull-left comment-time">{{ say.create_time }}</span>
                            <div class="date-dz-right pull-right comment-pl-block">
{#                                <a href="javascript:;" class="removeBlock">删除</a>#}
                                <a href="javascript:;" class="date-dz-pl pl-hf pull-left hf-con-block" sayid="{{ say.say_id }}">回复</a>
{#                                <span class="pull-left date-dz-line">|</span>#}

                            </div>
                        </div>
                        <div class="hf-list-con" style="display: block;">
                            {% for comment in say.comments %}
                                <div class="all-pl-con">
                                    <div class="pl-text hfpl-text clearfix">
                                        <a href="#" class="comment-size-name">{{ comment.username }}: </a><span
                                            class="my-pl-con">回复
                                        <a href="#" class="atName">{{ comment.beusername }} </a> : {{ comment.content }}</span>
                                    </div>
                                    <div class="date-dz">
                                        <span class="date-dz-left pull-left comment-time">{{ comment.create_time }}</span>
                                        <div class="date-dz-right pull-right comment-pl-block">
{#                                            <a href="javascript:;" class="removeBlock">删除</a>#}
                                            <a href="javascript:;"
                                               class="date-dz-pl pl-hf hf-con-block pull-left" sayid="{{ say.say_id }}">回复</a>
{#                                            <span class="pull-left date-dz-line">|</span>#}
{#                                            <a href="javascript:;" class="date-dz-z pull-left"><i class="date-dz-z-click-red"></i>赞 (<i class="z-num">666</i>)</a>#}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <!--回复区域 end-->
    </div>



    {#    <script type="text/javascript" src="{% static 'js/jquery-1.12.0.min.js' %}"></script>#}
    <script type="text/javascript" src="{% static 'js/jquery.flexText.js' %}"></script>
    <!--textarea高度自适应-->
    <script type="text/javascript">
        $(function () {
            $('.content').flexText();
        });
    </script>
    <!--textarea限制字数-->
    <script type="text/javascript">
        function keyUP(t) {
            var len = $(t).val().length;
            if (len > 139) {
                $(t).val($(t).val().substring(0, 140));
            }
        }
    </script>
    <!--点击评论创建评论条-->
    <script type="text/javascript">
        $('.commentAll').on('click', '.plBtn', function () {
            var myDate = new Date();
            //获取当前年
            var year = myDate.getFullYear();
            //获取当前月
            var month = myDate.getMonth() + 1;
            //获取当前日
            var date = myDate.getDate();
            var h = myDate.getHours();       //获取当前小时数(0-23)
            var m = myDate.getMinutes();     //获取当前分钟数(0-59)
            if (m < 10) m = '0' + m;
            var s = myDate.getSeconds();
            if (s < 10) s = '0' + s;
            var now = year + '-' + month + "-" + date + " " + h + ':' + m + ":" + s;
            //获取输入内容
            var oSize = $(this).siblings('.flex-text-wrap').find('.comment-input').val();
            if (oSize == "") {
                alert('说说不能为空');
                return;
            }
                {#var pics = $('#pic')[0].files[0];#}
                {#alert(oSize);#}
                {#console.log(oSize);#}
            else
                $.ajax({
                    url: '/reviews/reviews/',
                    type: 'POST',
                    data: {'now': now, 'osize': oSize},
                    async: false,
                    success: function (result) {
                        if (result.status) {
                            oHtml = '<div class="comment-show-con clearfix"><div class="comment-show-con-img pull-left"><img src="images/header-img-comment_03.png" alt=""></div> <div class="comment-show-con-list pull-left clearfix"><div class="pl-text clearfix"> <a href="#" class="comment-size-name">{{ request.user.username }} : </a> <span class="my-pl-con">&nbsp;' + result.content + '</span> </div> <div class="date-dz"> <span class="date-dz-left pull-left comment-time">' + result.create_time + '</span> <div class="date-dz-right pull-right comment-pl-block"> <a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left">回复</a> <span class="pull-left date-dz-line">|</span>  </div> </div><div class="hf-list-con"></div></div> </div>';
                        } else {
                            alert('发表失败');
                            oHtml = '';
                        }
                    }
                });
            //动态创建评论模块
            if (oSize.replace(/(^\s*)|(\s*$)/g, "") != '') {
                $(this).parents('.reviewArea ').siblings('.comment-show').prepend(oHtml);
                $(this).siblings('.flex-text-wrap').find('.comment-input').prop('value', '').siblings('pre').find('span').text('');
            }
        });
    </script>
    <!--点击回复动态创建回复块-->
    <script type="text/javascript">
        $('.comment-show').on('click', '.pl-hf', function () {
            //获取回复人的名字
            var sayid = $(this).attr('sayid');
            var fhName = $(this).parents('.date-dz-right').parents('.date-dz').siblings('.pl-text').find('.comment-size-name').html();
            //回复@
            var fhN = '回复@' + fhName;
            //var oInput = $(this).parents('.date-dz-right').parents('.date-dz').siblings('.hf-con');
            var fhHtml = '<div class="hf-con pull-left"> <textarea class="content comment-input hf-input" placeholder="" onkeyup="keyUP(this)"></textarea> <a href="javascript:;" class="hf-pl" id=' + sayid + '>评论</a></div>';
            //显示回复
            if ($(this).is('.hf-con-block')) {
                $(this).parents('.date-dz-right').parents('.date-dz').append(fhHtml);
                $(this).removeClass('hf-con-block');
                $('.content').flexText();
                $(this).parents('.date-dz-right').siblings('.hf-con').find('.pre').css('padding', '6px 15px');
                //console.log($(this).parents('.date-dz-right').siblings('.hf-con').find('.pre'))
                //input框自动聚焦
                $(this).parents('.date-dz-right').siblings('.hf-con').find('.hf-input').val('').focus().val(fhN);
            } else {
                $(this).addClass('hf-con-block');
                $(this).parents('.date-dz-right').siblings('.hf-con').remove();
            }
        });
    </script>
    <!--评论回复块创建-->
    <script type="text/javascript">
        $('.comment-show').on('click', '.hf-pl', function () {
            var oThis = $(this);
            var say_id = $(this).attr('id');
            var myDate = new Date();
            //获取当前年
            var year = myDate.getFullYear();
            //获取当前月
            var month = myDate.getMonth() + 1;
            //获取当前日
            var date = myDate.getDate();
            var h = myDate.getHours();       //获取当前小时数(0-23)
            var m = myDate.getMinutes();     //获取当前分钟数(0-59)
            if (m < 10) m = '0' + m;
            var s = myDate.getSeconds();
            if (s < 10) s = '0' + s;
            var now = year + '-' + month + "-" + date + " " + h + ':' + m + ":" + s;
            //获取输入内容
            var oHfName = $(this).parents('.hf-con').parents('.date-dz').siblings('.pl-text').find('.comment-size-name').html();
            var oHfName1 = oHfName.replace(':','');
            {#alert(oHfName1);#}
            var oHfVal = $(this).siblings('.flex-text-wrap').find('.hf-input').val();
            var oHVal1 = oHfVal.replace('回复@' + oHfName, ''); //真正的回复
            console.log(oHfVal);

            $.ajax({
                url: '/reviews/reviews/',
                type: 'POST',
                data: {'now': now, 'ohval1': oHVal1, 'oHfName': oHfName1,'say_id':say_id},
                async: false,
                success: function (result) {
                    if (result.status) {
                        oHtml = '<div class="all-pl-con"><div class="pl-text hfpl-text clearfix"><a href="#" class="comment-size-name">{{ request.user.username }}</a><span class="my-pl-con">:回复@<a href="#" class="comment-size-name">' + result.username+ '</a> </span>'+result.content+'</div><div class="date-dz"> <span class="date-dz-left pull-left comment-time">' + result.create_time + '</span> <div class="date-dz-right pull-right comment-pl-block">  <a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left">回复</a> <span class="pull-left date-dz-line">|</span> </div> </div></div>';
                        oThis.parents('.hf-con').parents('.comment-show-con-list').find('.hf-list-con').css('display', 'block').prepend(oHtml) && oThis.parents('.hf-con').siblings('.date-dz-right').find('.pl-hf').addClass('hf-con-block') && oThis.parents('.hf-con').remove();

                    } else {
                        alert('发表失败');
                        oHtml = '';
                    }
                }
            });
        });
    </script>
    <!--删除评论块-->
    <script type="text/javascript">
        $('.commentAll').on('click', '.removeBlock', function () {
            var oT = $(this).parents('.date-dz-right').parents('.date-dz').parents('.all-pl-con');
            if (oT.siblings('.all-pl-con').length >= 1) {
                oT.remove();
            } else {
                $(this).parents('.date-dz-right').parents('.date-dz').parents('.all-pl-con').parents('.hf-list-con').css('display', 'none')
                oT.remove();
            }
            $(this).parents('.date-dz-right').parents('.date-dz').parents('.comment-show-con-list').parents('.comment-show-con').remove();

        })
    </script>
    <!--点赞-->
    <script type="text/javascript">
        $('.comment-show').on('click', '.date-dz-z', function () {
            var zNum = $(this).find('.z-num').html();
            if ($(this).is('.date-dz-z-click')) {
                zNum--;
                $(this).removeClass('date-dz-z-click red');
                $(this).find('.z-num').html(zNum);
                $(this).find('.date-dz-z-click-red').removeClass('red');
            } else {
                zNum++;
                $(this).addClass('date-dz-z-click');
                $(this).find('.z-num').html(zNum);
                $(this).find('.date-dz-z-click-red').addClass('red');
            }
        })
    </script>
{% endblock %}
